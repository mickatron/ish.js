<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ish.js | Source: js/ish.router.js</title>
    <link type="text/css" rel="stylesheet" href="main.css">
</head>

<body>
<div class="l-header" data-scrollpop="header">
    <header data-scrollpop-bar>
        <div class="l-header__content" data-scrollpop-content>
            <h1><a href="/js/docs/">ish.js API Doc <span>(alpha)</span></a></h1>

            <button data-ui-main-nav--toggle class="c-main-nav__toggle icon--menu">
              <span></span>
              <span></span>
              <span></span>
            </button>
            
            <nav data-ui-main-nav class="c-main-nav">
                <div class="c-main-nav__inner">
                    
<!--<h3 class="applicationName"><a href="index.html"></a></h3> -->

<ul class="c-menu c-menu--alpha">

    <li data-name="ish">
        
        <a href="ish.html">ish</a>
        
        <!--<span class="static">static</span>-->
        
        
        
        
        <ul class="c-menu__members">
            <li><span class="c-menu__subtitle">Properties</span></li>
        
            <li data-name="ish.fn"><a href="ish.html#.fn">fn</a></li>
            
            
        </ul>
        
        
        
        <ul class="c-menu__members">
            <li><span class="c-menu__subtitle">Methods</span></li>
        
            <li data-name="ish.ajax"><a href="ish.html#.ajax">ajax</a></li>
            
            <li data-name="ish.bindToObject"><a href="ish.html#.bindToObject">bindToObject</a></li>
            
            <li data-name="ish.ish"><a href="ish.html#.ish">ish</a></li>
            
            <li data-name="ish.renderBind"><a href="ish.html#.renderBind">renderBind</a></li>
            
            <li data-name="ish.renderTemplate"><a href="ish.html#.renderTemplate">renderTemplate</a></li>
            
            <li data-name="ish.resolveObjectPath"><a href="ish.html#.resolveObjectPath">resolveObjectPath</a></li>
            
            <li data-name="ish.setPathByString"><a href="ish.html#.setPathByString">setPathByString</a></li>
            
            <li data-name="ish.updateTemplate"><a href="ish.html#.updateTemplate">updateTemplate</a></li>
            
            <li data-name="ish#extend"><a href="ish.html#extend">extend</a></li>
            
            
        </ul>
        
    </li>

    <li data-name="ish.responsive">
        
        <a href="ish.responsive.html">ish.responsive</a>
        
        
        
        <ul class="c-menu__members">
            <li><span class="c-menu__subtitle">Events</span></li>
            
                <li data-name="ish.responsive.event:onMediaBreak"><a href="ish.responsive.html#.event:onMediaBreak">onMediaBreak</a></li>
            
            
        </ul>
        
        
        <ul class="c-menu__members">
            <li><span class="c-menu__subtitle">Properties</span></li>
        
            <li data-name="ish.responsive.destroy"><a href="ish.responsive.html#.destroy">destroy</a></li>
            
            
        </ul>
        
        
        
        <ul class="c-menu__members">
            <li><span class="c-menu__subtitle">Methods</span></li>
        
            <li data-name="ish.responsive.add"><a href="ish.responsive.html#.add">add</a></li>
            
            <li data-name="ish.responsive.remove"><a href="ish.responsive.html#.remove">remove</a></li>
            
            
        </ul>
        
    </li>

    <li data-name="ish.fn.ishObject">
        
        <a href="ish.fn.ishObject.html">ish.fn.ishObject</a>
        
        
        
        
        
        
        <ul class="c-menu__members">
            <li><span class="c-menu__subtitle">Methods</span></li>
        
            <li data-name="ish.fn.ishObject.addClass"><a href="ish.fn.ishObject.html#.addClass">addClass</a></li>
            
            <li data-name="ish.fn.ishObject.attr"><a href="ish.fn.ishObject.html#.attr">attr</a></li>
            
            <li data-name="ish.fn.ishObject.css"><a href="ish.fn.ishObject.html#.css">css</a></li>
            
            <li data-name="ish.fn.ishObject.dimension"><a href="ish.fn.ishObject.html#.dimension">dimension</a></li>
            
            <li data-name="ish.fn.ishObject.forEach"><a href="ish.fn.ishObject.html#.forEach">forEach</a></li>
            
            <li data-name="ish.fn.ishObject.hasClass"><a href="ish.fn.ishObject.html#.hasClass">hasClass</a></li>
            
            <li data-name="ish.fn.ishObject.height"><a href="ish.fn.ishObject.html#.height">height</a></li>
            
            <li data-name="ish.fn.ishObject.indexOf"><a href="ish.fn.ishObject.html#.indexOf">indexOf</a></li>
            
            <li data-name="ish.fn.ishObject.nth"><a href="ish.fn.ishObject.html#.nth">nth</a></li>
            
            <li data-name="ish.fn.ishObject.off"><a href="ish.fn.ishObject.html#.off">off</a></li>
            
            <li data-name="ish.fn.ishObject.offset"><a href="ish.fn.ishObject.html#.offset">offset</a></li>
            
            <li data-name="ish.fn.ishObject.on"><a href="ish.fn.ishObject.html#.on">on</a></li>
            
            <li data-name="ish.fn.ishObject.removeClass"><a href="ish.fn.ishObject.html#.removeClass">removeClass</a></li>
            
            <li data-name="ish.fn.ishObject.trigger"><a href="ish.fn.ishObject.html#.trigger">trigger</a></li>
            
            <li data-name="ish.fn.ishObject.width"><a href="ish.fn.ishObject.html#.width">width</a></li>
            
            
        </ul>
        
    </li>

    <li data-name="ish.fn.easing">
        
        <a href="ish.fn.easing.html">ish.fn.easing</a>
        
        <!--<span class="static">static</span>-->
        
        
        
        
        
        
        <ul class="c-menu__members">
            <li><span class="c-menu__subtitle">Methods</span></li>
        
            <li data-name="ish.fn.easing.easeInCirc"><a href="ish.fn.easing.html#.easeInCirc">easeInCirc</a></li>
            
            <li data-name="ish.fn.easing.easeInCubic"><a href="ish.fn.easing.html#.easeInCubic">easeInCubic</a></li>
            
            <li data-name="ish.fn.easing.easeInExpo"><a href="ish.fn.easing.html#.easeInExpo">easeInExpo</a></li>
            
            <li data-name="ish.fn.easing.easeInOutCirc"><a href="ish.fn.easing.html#.easeInOutCirc">easeInOutCirc</a></li>
            
            <li data-name="ish.fn.easing.easeInOutCubic"><a href="ish.fn.easing.html#.easeInOutCubic">easeInOutCubic</a></li>
            
            <li data-name="ish.fn.easing.easeInOutExpo"><a href="ish.fn.easing.html#.easeInOutExpo">easeInOutExpo</a></li>
            
            <li data-name="ish.fn.easing.easeInOutQuad"><a href="ish.fn.easing.html#.easeInOutQuad">easeInOutQuad</a></li>
            
            <li data-name="ish.fn.easing.easeInOutQuart"><a href="ish.fn.easing.html#.easeInOutQuart">easeInOutQuart</a></li>
            
            <li data-name="ish.fn.easing.easeInOutQuint"><a href="ish.fn.easing.html#.easeInOutQuint">easeInOutQuint</a></li>
            
            <li data-name="ish.fn.easing.easeInOutSine"><a href="ish.fn.easing.html#.easeInOutSine">easeInOutSine</a></li>
            
            <li data-name="ish.fn.easing.easeInQuad"><a href="ish.fn.easing.html#.easeInQuad">easeInQuad</a></li>
            
            <li data-name="ish.fn.easing.easeInQuart"><a href="ish.fn.easing.html#.easeInQuart">easeInQuart</a></li>
            
            <li data-name="ish.fn.easing.easeInQuint"><a href="ish.fn.easing.html#.easeInQuint">easeInQuint</a></li>
            
            <li data-name="ish.fn.easing.easeInSine"><a href="ish.fn.easing.html#.easeInSine">easeInSine</a></li>
            
            <li data-name="ish.fn.easing.easeOutCirc"><a href="ish.fn.easing.html#.easeOutCirc">easeOutCirc</a></li>
            
            <li data-name="ish.fn.easing.easeOutCubic"><a href="ish.fn.easing.html#.easeOutCubic">easeOutCubic</a></li>
            
            <li data-name="ish.fn.easing.easeOutExpo"><a href="ish.fn.easing.html#.easeOutExpo">easeOutExpo</a></li>
            
            <li data-name="ish.fn.easing.easeOutQuad"><a href="ish.fn.easing.html#.easeOutQuad">easeOutQuad</a></li>
            
            <li data-name="ish.fn.easing.easeOutQuart"><a href="ish.fn.easing.html#.easeOutQuart">easeOutQuart</a></li>
            
            <li data-name="ish.fn.easing.easeOutQuint"><a href="ish.fn.easing.html#.easeOutQuint">easeOutQuint</a></li>
            
            <li data-name="ish.fn.easing.easeOutSine"><a href="ish.fn.easing.html#.easeOutSine">easeOutSine</a></li>
            
            <li data-name="ish.fn.easing.linear"><a href="ish.fn.easing.html#.linear">linear</a></li>
            
            
        </ul>
        
    </li>

    <li data-name="ish.store">
        
        <a href="ish.store.html">ish.store</a>
        
        <!--<span class="static">static</span>-->
        
        
        
        
        
        
        <ul class="c-menu__members">
            <li><span class="c-menu__subtitle">Methods</span></li>
        
            <li data-name="ish.store.createComState"><a href="ish.store.html#.createComState">createComState</a></li>
            
            <li data-name="ish.store.createDataState"><a href="ish.store.html#.createDataState">createDataState</a></li>
            
            <li data-name="ish.store.flush"><a href="ish.store.html#.flush">flush</a></li>
            
            
        </ul>
        
    </li>

    <li data-name="ish.emitter">
        
        <a href="ish.emitter.html">ish.emitter</a>
        
        
        
        
        
        
        <ul class="c-menu__members">
            <li><span class="c-menu__subtitle">Methods</span></li>
        
            <li data-name="ish.emitter.emit"><a href="ish.emitter.html#.emit">emit</a></li>
            
            <li data-name="ish.emitter.flush"><a href="ish.emitter.html#.flush">flush</a></li>
            
            <li data-name="ish.emitter.subscribe"><a href="ish.emitter.html#.subscribe">subscribe</a></li>
            
            <li data-name="ish.emitter.unsubscribe"><a href="ish.emitter.html#.unsubscribe">unsubscribe</a></li>
            
            
        </ul>
        
    </li>

    <li data-name="ish.router">
        
        <a href="ish.router.html">ish.router</a>
        
        
        
        
        
        
        <ul class="c-menu__members">
            <li><span class="c-menu__subtitle">Methods</span></li>
        
            <li data-name="ish.router.add"><a href="ish.router.html#.add">add</a></li>
            
            
        </ul>
        
    </li>

</ul>

                </div>
                <button data-ui-main-nav--toggle class="c-main-nav__close">Close Menu</button>
            </nav>
         </div>
    </header> 
</div> 
<div class="l-doc" role="document">
    <main class="l-main">
            <div class="l-main__content">
                



	
    <section class="c-source-content">
        <article>
            <pre class="prettyprint source linenums"><code>// TODO: catch refreshes?.?.?
// TODO: 

(function(){
	var _historyAPI = window.history;

	function arrayFindString(str, strArray) {
		var matches = {
			values:[],
			index:[]
		};
	    for (var j=0; j&lt;strArray.length; j++) {
	        if (strArray[j].match(str)) {
	        	matches.index.push(j);
	        	matches.values.push(strArray[j]);
	        }
	    }
	    if(matches.index.length) return matches;
	    return -1;
	}

	function callRouteFn(routeKey, slugs, stateData) {
			var routes = this.routes;
			if( routes.before ) routes.before( stateData );
			routes[routeKey].enter(slugs, stateData);
			if( routes.after ) routes.after( stateData );
	}

	// TODO: split this up in smaller more specific tasks - it's too large
	function parseURLroute (routeString, stateData){
		routeString = routeString || '';
		// get all the route keys
		var keys = Object.keys(this.routes);
		var routeKeys = [];
		var wildcardKeys = keys.filter(function(item){  
			if(item.substr(item.length -1) === '*') {
				return true;
			} else {
				routeKeys.push(item);
				return false;
			}
		});

		// test exact routes
		var exact = routeKeys.indexOf(routeString);
		var routeKey;

		if(exact >= 0) {
			routeKey =  routeKeys[exact];
		} else {
			// not exact
			var routeArray = routeString.split('/');
			routeArray.shift();
			var matches = arrayFindString(routeArray[0], routeKeys);
			var fnIndexMatches = matches.index;
			var fnKeyMatches = matches.values;

			// if theres more than one match refine by string comparison
			if(fnIndexMatches.length > 1){
				var refineMatch = {
					index:[],
					values:[]
				}; 
				var mostPoints = 0;
				var mostSimilar;
				for (var i = 0; i &lt; fnKeyMatches.length; i++) {
					var newArr = fnKeyMatches[i].split('/');
					newArr.shift();
					var points = 0;
					if( newArr.length === routeArray.length){
						for (var val = 0; val &lt; newArr.length; val++) {
							if(newArr[val] === routeArray[val]){
								points++;
							}
							if(points > mostPoints) {
								mostPoints = points;
								mostSimilar = i;
							}
						}
					}
				}
				if(matches.index[mostSimilar]){
					refineMatch.index.push(matches.index[mostSimilar]);
					refineMatch.values.push(matches.values[mostSimilar]);
				}
				matches = refineMatch;
			}
			
			//console.log( 'routeString  ', routeString, matches);
			// only 1  match should exisit in the matches object by now.
			if (matches.index.length === 0) { 
				this.routes.notFound(routeString);
				this.emit('ROUTE_NOT_FOUND', { route: routeString });
				return; 
			} else if (matches.index.length > 1) { 
				console.error('More than 1 route found'); 
			}

			// set the current slugs and the routeKey to call
			this.slugs = getSlugs(matches, routeArray); 
			routeKey = matches.values[0];
		}

		// call previous onLeave handler
		var routeFnObj = this.routes[this.current];
		if(routeFnObj &amp;&amp; routeFnObj.leave) routeFnObj.leave();
		
		if(this.current){
			// call previous onLeave handler for wildcards
			for (var e = 0; e &lt; wildcardKeys.length; e++) {
				if(this.current.indexOf( wildcardKeys[e].replace('*','') ) === 0 ){
					var leaveFn = this.routes[ wildcardKeys[e] ].leave;
					if(leaveFn) leaveFn();
				}
			}
		}
		// test and call wildcards
		for (var d = 0; d &lt; wildcardKeys.length; d++) {
			if(routeString.indexOf( wildcardKeys[d].replace('*','') ) === 0 ){
				callRouteFn.call(this, wildcardKeys[d], this.slugs, stateData);
			}
		}

		// call the singel route found in the first tests
		callRouteFn.call(this, routeKey, this.slugs, stateData);
		this.current = routeString;
		var returnVal =  {route: routeString, previousRoute: this.current, slugs: this.slugs };
		
		return returnVal;
	}
	

	function getSlugs(matches, routeArray){
		var hasSlugs = false;
		// get any slug values 
		var splitMatchArray = matches.values[0].split('/');
		splitMatchArray.shift();
		//find slugs
		var slugs = {};
		for (var match = 1; match &lt; splitMatchArray.length; match++) {
			// is it a slug? 
			var isSlug = splitMatchArray[match].charAt(0) + splitMatchArray[match].charAt(splitMatchArray[match].length-1);
			if(isSlug === '{}') {
				hasSlugs = true;
				// it's a slug!
				var slugName =  splitMatchArray[match].slice(1,-1);
				var slugValue = routeArray[match];
				slugs[slugName] = slugValue;
			}
		}
		return hasSlugs ? slugs : null;
	}

	function setState() {
		// store the state datat in localStorage, history.state has a 640kB limit.
		var stateString = JSON.stringify({data:$.store.data, states: $.store.states});
		localStorage.setItem(this.current, stateString);
	}

	$.fn.router = {
		/**
		 * Add a route to the router instance.
		 * @memberOf ish.router
		 * @param {String}   route The route path you're adding.
		 * @param {Object} fn    The routing object conatining 'enter' and 'leave' functions keyed by their respective name.
		 * @return {ish.router}       Chainable, returns its own instance.
		 */
		add: function(route, fn){
			this.routes[route] = fn;
			return this;
		},
		/**
		 * Remove a route from the router instance.
		 * @param {String}   route The route path to remove.
		 * @return {ish.router}       Chainable, returns its own instance.
		 */
		remove: function(route){
			delete this.routes[route];
			return this;
		},
		/**
		 * Flush/remove all routes from the router instance.
		 * @return {ish.router}       Chainable, returns its own instance.
		 */
		flush: function(){
			this.routes = {};
			return this;
		},
		/**
		 * Navigate to the specified route path.
		 * @param {String}   route The route path to remove.
		 * @return {ish.router}       Chainable, returns its own instance.
		 */
		navigate: function(route){
			setState.call(this); // set state of the current page
			var routeData = parseURLroute.call(this, route); // parse url route and switch pages
			_historyAPI.pushState(routeData, '', this.current);
			this.emit('ON_NAVIGATE', routeData);
			return this;
		},
		/**
		 * Destroy the router instance.
		 * @return {null}   
		 */
		destroy: function(){
			$(window).off('popstate', this.popHandler);
			return null;
		}
	};

	var popHandler = function(evt){
		setState.call(this);
		//get state
		var route;
		var stateData;
		if (history.state){
			var historyState = history.state;
			stateData = JSON.parse(localStorage.getItem(historyState.route));
			route = parseURLroute.call(this, historyState.route, stateData);
		} else {
			currentLocation = document.URL.replace(this.baseURL,'');
			route = parseURLroute.call(this, currentLocation);
		}
		this.emit('ON_POP', route);
		return stateData;
	};

	/**
	 * An application router.
	 * @name  ish.router
	 * @constructor
	 * @extends {ish.emitter}
	 * @param  {Object} options The utilities options object.
	 * @param  {String} options.baseURL The base URL of the application.
	 * @param  {Object} options.routes The routing object.
	 * @return {$.router}         The router instance
	 *
	 * @example
	 * var router = ish.router({ 
	 *		baseURL: 'http://ish.stateful.local',
	 *		routes: {
	 *			notFound: function(url){
	 *			},
	 *			before: function(history){
	 *			
	 *			},
	 *			after: function(history){
	 *			
	 *			},
	 *			'/':  {
	 *				enter: function(slugs, history){
	 *
	 *				},
	 *				leave: function(slugs, history){
	 *				}
	 *			}
	 *		}
	 * };
	 */
	$.router = function(options){
		var factory = Object.create($.fn.router);
		ish.extend(factory, ish.emitter(), options);
		var currentLocation = document.URL.replace(factory.baseURL,'');
		//console.log('currentLocation ',currentLocation,factory.baseURL);
		factory.popHandler = popHandler.bind(factory);
		$(window).on('popstate', factory.popHandler);
		//parses the inital route
		parseURLroute.call(factory, currentLocation);
		// add history state for the current page
		_historyAPI.replaceState({route: factory.current, slugs: factory.slugs }, "", factory.current);
		return factory;
	};

})();
</code></pre>
        </article>
    </section>




            </div>
    </main>
</div>

    <!-- <footer>
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Apr 07 2017 01:42:24 GMT+1000 (AUS Eastern Standard Time)
    </footer> -->
<script src="../../js/dist/ish.min.js"> </script>
<script src="main.js"> </script>

</body>
</html>
